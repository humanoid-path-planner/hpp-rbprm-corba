from hpp.corbaserver.rbprm.rbprmbuilder import Builder
from hpp.corbaserver.rbprm.rbprmfullbody import FullBody
from hpp.gepetto import Viewer

import time

packageName = "hyq_description"
meshPackageName = "hyq_description"
rootJointType = "freeflyer"

#  Information to retrieve urdf and srdf files.
urdfName = "hyq"
urdfSuffix = ""
srdfSuffix = ""

#  This time we load the full body model of HyQ
fullBody = FullBody()
fullBody.loadFullBodyModel(
    urdfName, rootJointType, meshPackageName, packageName, urdfSuffix, srdfSuffix
)
fullBody.setJointBounds("base_joint_xyz", [-2, 5, -1, 1, 0.3, 4])

#  Setting a number of sample configurations used
nbSamples = 20000

rootName = "base_joint_xyz"

cType = "_3_DOF"
rLegId = "rhleg"
rLeg = "rh_haa_joint"
rfoot = "rh_foot_joint"
offset = [0.0, -0.021, 0.0]
normal = [0, 1, 0]
legx = 0.02
legy = 0.02


def addLimbDb(limbId, heuristicName, loadValues=True, disableEffectorCollision=False):
    fullBody.addLimbDatabase(
        str(db_dir + limbId + ".db"),
        limbId,
        heuristicName,
        loadValues,
        disableEffectorCollision,
    )


fullBody.addLimb(
    rLegId,
    rLeg,
    rfoot,
    offset,
    normal,
    legx,
    legy,
    nbSamples,
    "jointlimits",
    0.1,
    cType,
)

lLegId = "lhleg"
lLeg = "lh_haa_joint"
lfoot = "lh_foot_joint"
fullBody.addLimb(
    lLegId,
    lLeg,
    lfoot,
    offset,
    normal,
    legx,
    legy,
    nbSamples,
    "jointlimits",
    0.05,
    cType,
)
# ~
rarmId = "rfleg"
rarm = "rf_haa_joint"
rHand = "rf_foot_joint"
fullBody.addLimb(
    rarmId,
    rarm,
    rHand,
    offset,
    normal,
    legx,
    legy,
    nbSamples,
    "jointlimits",
    0.05,
    cType,
)

larmId = "lfleg"
larm = "lf_haa_joint"
lHand = "lf_foot_joint"
fullBody.addLimb(
    larmId,
    larm,
    lHand,
    offset,
    normal,
    legx,
    legy,
    nbSamples,
    "jointlimits",
    0.05,
    cType,
)

fullBody.runLimbSampleAnalysis(rLegId, "jointLimitsDistance", True)
fullBody.runLimbSampleAnalysis(lLegId, "jointLimitsDistance", True)
fullBody.runLimbSampleAnalysis(rarmId, "jointLimitsDistance", True)
fullBody.runLimbSampleAnalysis(larmId, "jointLimitsDistance", True)


limbsCOMConstraints = {
    rLegId: {"file": "hyq/" + rLegId + "_com.ineq", "effector": rfoot},
    lLegId: {"file": "hyq/" + lLegId + "_com.ineq", "effector": lfoot},
    rarmId: {"file": "hyq/" + rarmId + "_com.ineq", "effector": rHand},
    larmId: {"file": "hyq/" + larmId + "_com.ineq", "effector": lHand},
}
